#!/bin/zsh

BACKUPDIR=${TMPDIR:-${HOME}/.scriptblock}

[[ -d "${BACKUPDIR}" ]] || mkdir -p "${BACKUPDIR}"

SCRIPTBLOCK_CSV_WHITELIST_FILENAME_STEM="scriptblock-domains"

CNT=$(($(find $BACKUPDIR -iname "${SCRIPTBLOCK_CSV_WHITELIST_FILENAME_STEM}*" | wc -l)))
[[ ${CNT} -gt 0 ]] && NUMBER_WHITELIST_CSVs=${CNT} || NUMBER_WHITELIST_CSVs=1

SCRIPTBLOCK_CSV_WHITELIST_TMPDIR_BACKUP="${BACKUPDIR}/${SCRIPTBLOCK_CSV_WHITELIST_FILENAME_STEM}"

#NUMBER_WHITELIST_CSVs=$(ls -1 "${BACKUPDIR}/${SCRIPTBLOCK_CSV_WHITELIST_FILENAME_STEM}"* | wc -l)

SCRIPTBLOCK_CSV_WHITELIST_TMPDIR_BACKUP+="-${NUMBER_WHITELIST_CSVs}"

SCRIPTBLOCK_CSV_WHITELIST_TMPDIR_BACKUP+="-$(date +%s)"

SCRIPTBLOCK_CSV_WHITELIST_TMPDIR_BACKUP+='.csv'

_setup-latest-state() {
    [[ -f ${SCRIPTBLOCK_CSV_MERGER} ]] || cp "${SCRIPTBLOCK_CSV_WHITELIST}" "${SCRIPTBLOCK_CSV_MERGER}"
}

_scriptblock-add2domains () {
	pbwrite -a ${SCRIPTBLOCK_CSV_MERGER}
    pbwrite ${TMPDIR}/scriptblock-domain
    sort ${SCRIPTBLOCK_CSV_MERGER} -o ${SCRIPTBLOCK_CSV_MERGER}
}
_setup-latest-state
_scriptblock-add2domains ${@}
